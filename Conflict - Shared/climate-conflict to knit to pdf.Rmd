---
title: "climate-conflict analysis"
author: "Jessica Anderson"
date: "5/5/2021"
output: pdf_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Loading libraries
library(tidymodels) 
library(lubridate) 
library(fixest) # fixed effects package
library(discrim) # Linear Discriminant Model
library(tidyverse)
library(here) # used for relative filepath
library(raster) # used for importing shapefile
library(ncdf4) # used for reading netCDF file
library(sf) # used for spatial join
library(rmarkdown)
library(knitr)
library(tinytex)
library(stargazer)
```

# Preparing data for modeling

```{r prep-analysis}
# read in region-month panel data and full climate data for baseline
region_month <- read_csv("climate-conflict_region-month_panel.csv")
climate_1987to2021 <- read_csv("climate_1987to2021.csv")

# extract temperature and precipitation mean and sd from 1987 to 1996 data
climate_baselines <- climate_1987to2021 %>% 
  mutate(year = year(date)) %>% 
  filter(dplyr::between(year, 1987, 1996)) %>% 
  group_by(region_id) %>% 
  summarise(
    mean_temp2mc_baseline = mean(temp2m_c), 
    mean_prcpmm_baseline = mean(prcp_mm), 
    sd_temp2mc_baseline = sd(temp2m_c),
    sd_prcpmm_baseline = sd(prcp_mm)
  )

# create standardized climate variables (std deviational units from baseline mean)
region_month <- region_month %>% 
  left_join(climate_baselines, by = "region_id") %>% 
  mutate(
    temp2m_c_std = (temp2m_c - mean_temp2mc_baseline) / sd_temp2mc_baseline, 
    prcp_mm_std = (prcp_mm - mean_prcpmm_baseline) / sd_prcpmm_baseline
  )

# collapse to region-year panel
region_year <- region_month %>% 
  mutate(year = year(date)) %>% 
  group_by(region_name, year) %>% 
  summarise(
    region_id = mean(region_id), # keep region id in aggregated data
    temp2m_c = mean(temp2m_c),
    prcp_mm = mean(prcp_mm),
    temp2m_c_std = mean(temp2m_c_std),
    prcp_mm_std = mean(prcp_mm_std),
    events_count = sum(events_count), # count of all events (any type)
    battles_count = sum(battles_count),
    explosions_count = sum(explosions_count),
    protests_count = sum(protests_count),
    riots_count = sum(riots_count),
    strategic_count = sum(strategic_count), 
    violence_civ_count = sum(violence_civ_count), 
    state_forces_count = sum(state_forces_count), 
    rebels_count = sum(rebels_count), 
    pol_militias_count = sum(pol_militias_count), 
    id_militias_count = sum(id_militias_count), 
    rioters_count = sum(rioters_count), 
    protesters_count = sum(protesters_count), 
    external_count = sum(external_count),
    fatalities_count = sum(fatalities_count)
  ) %>% 
  ungroup() %>% 
  dplyr::select(region_id, everything())

# add additional variables for analysis
region_year <- region_year %>% 
  mutate(prcp_mm_std_abs = abs(prcp_mm_std), .after = prcp_mm_std) %>% 
  rowwise() %>% 
  mutate(
    protests_riots = protests_count + riots_count,
    battles_explosions = battles_count + explosions_count
  ) %>% 
  ungroup()
```

# Initial models

```{r fixest-models}
temp_unit_feols <- feols(
  events_count ~ temp2m_c_std | region_id, # by default clusters SEs on region_id
  data = region_year
)
prcp_unit_feols <- feols(
  events_count ~ prcp_mm_std | region_id, # by default clusters SEs on region_id
  data = region_year
)
both_unit_feols <- feols(
  events_count ~ temp2m_c_std + prcp_mm_std | region_id, # clusters on region_id
  data = region_year
)
both_twoway_feols <- feols(
  events_count ~ temp2m_c_std + prcp_mm_std | region_id + year,
  data = region_year,
  cluster = ~region_id + year
)

midpoint_table <- etable(
  both_unit_feols, both_twoway_feols, 
  subtitles = c("Region FE", "Region & Year FE")
  )
midpoint_table %>% kable()
```

```{r latex-midpoint, results='asis'}
etable(
  both_unit_feols, both_twoway_feols,
  subtitles = c("Region FE", "Region & Year FE"), 
  tex = TRUE
)
```

# Model extensions

```{r model-extensions}
# model protests/riots, battles/explosions, & violence against civilians separately
separatedvs_regionFE <- feols(
  c(protests_riots, battles_explosions, violence_civ_count) ~ 
    temp2m_c_std + prcp_mm_std | region_id,
  data = region_year
)
separatedvs_twowayFE <- feols(
  c(protests_riots, battles_explosions, violence_civ_count) ~ 
    temp2m_c_std + prcp_mm_std | region_id + year,
  data = region_year,
  cluster = ~region_id + year
)

# model event types with region FE and year as linear regressor
separatedvs_yearcontrol <- feols(
  c(protests_riots, battles_explosions, violence_civ_count) ~ 
    temp2m_c_std + prcp_mm_std + year | region_id,
  data = region_year
)

# model contemporaneous and one lag
# drops the earliest year because no lag
allevents_twowayFE_1to0 <- feols(
  events_count ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) | region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
) 
protests_twowayFE_1to0 <- feols(
  protests_riots ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)
battles_twowayFE_1to0 <- feols(
  battles_explosions ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)
violciv_twowayFE_1to0 <- feols(
  violence_civ_count ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)

# test additional lags
protests_twowayFE_3to0 <- feols(
  protests_riots ~ l(temp2m_c_std, 0:3) + l(prcp_mm_std, 0:3) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)
battles_twowayFE_3to0 <- feols(
  battles_explosions ~ l(temp2m_c_std, 0:3) + l(prcp_mm_std, 0:3) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)
violciv_twowayFE_3to0 <- feols(
  violence_civ_count ~ l(temp2m_c_std, 0:3) + l(prcp_mm_std, 0:3) | 
    region_id + year,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id + year
)

# model contemporaneous + 1 lag with year regressor
protests_yearcontrol_1to0 <- feols(
  protests_riots ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) + year | 
    region_id,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id
)
battles_yearcontrol_1to0 <- feols(
  battles_explosions ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) + year | 
    region_id,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id
)
violciv_yearcontrol_1to0 <- feols(
  violence_civ_count ~ l(temp2m_c_std, 0:1) + l(prcp_mm_std, 0:1) + year | 
    region_id,
  data = region_year %>% filter(year < 2021),
  panel.id = ~region_id + year,
  cluster = ~region_id
)
```

```{r latex-extensions, results = 'asis'}
etable(
  separatedvs_regionFE$protests_riots, separatedvs_twowayFE$protests_riots, 
  separatedvs_yearcontrol$protests_riots, 
  tex = TRUE
)
etable(
  separatedvs_regionFE$battles_explosions, separatedvs_twowayFE$battles_explosions, 
  separatedvs_yearcontrol$battles_explosions, 
  tex = TRUE
)
etable(
  separatedvs_regionFE$violence_civ_count, separatedvs_twowayFE$violence_civ_count, 
  separatedvs_yearcontrol$violence_civ_count, 
  tex = TRUE
)
etable(
  protests_twowayFE_1to0, battles_twowayFE_1to0, violciv_twowayFE_1to0, 
  tex = TRUE
)
etable(
  protests_twowayFE_3to0, battles_twowayFE_3to0, violciv_twowayFE_3to0, 
  tex = TRUE
)
etable(
  protests_yearcontrol_1to0, battles_yearcontrol_1to0, violciv_yearcontrol_1to0, 
  tex = TRUE
)
```
